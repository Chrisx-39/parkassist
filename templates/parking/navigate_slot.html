{% extends "base.html" %}

{% block content %}
<div class="mt-8">
    <!-- Header Section -->
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-gray-800">
            Navigate to <span class="text-blue-600">{{ slot.slot_id }}</span>
        </h1>
        <a href="{% url 'find_free_slots' slot.area.id %}" 
           class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition">
           Back to Free Slots
        </a>
    </div>

    <!-- Map Card -->
    <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
        <div id="map" class="w-full h-[500px]"></div>
    </div>

    <!-- Occupy Slot Action -->
    <div class="mt-6 flex justify-end">
        <a href="{% url 'update_slot_status' slot.id %}" 
           class="inline-flex items-center bg-blue-600 text-white px-5 py-2 rounded-md hover:bg-blue-700 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" 
                 viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" 
                      d="M5 13l4 4L19 7" />
            </svg>
            Occupy This Slot
        </a>
    </div>
</div>

<!-- Leaflet & Routing Scripts -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
/>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Slot coordinates from server
    const slotLat = {{ slot.latitude|default:"0" }};
    const slotLng = {{ slot.longitude|default:"0" }};

    // Initialize map centered on the slot
    var map = L.map('map').setView([slotLat, slotLng], 15);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    // Parking slot marker
    var slotMarker = L.marker([slotLat, slotLng]).addTo(map)
        .bindPopup("<b>{{ slot.slot_id }}</b><br>Destination");

    // Helper: read URL query param
    function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    // Determine simulated origin:
    // 1) If lat & lng passed via query params, use them.
    // 2) Otherwise generate a nearby point (small offset from slot).
    let userLat = parseFloat(getQueryParam('lat'));
    let userLng = parseFloat(getQueryParam('lng'));

    if (!isFinite(userLat) || !isFinite(userLng)) {
        // fixed nearby offset (approx 50-200 meters)
        // you can tweak these offsets to change starting distance/direction
        const offsetLat = 0.0008;  // ~89m
        const offsetLng = 0.0007;  // ~73m
        // Randomize sign slightly so the origin is not always the same side
        const signLat = Math.random() < 0.5 ? -1 : 1;
        const signLng = Math.random() < 0.5 ? -1 : 1;

        userLat = slotLat + (signLat * (Math.random() * offsetLat));
        userLng = slotLng + (signLng * (Math.random() * offsetLng));
    }

    // Add a simulated "You are here" marker
    var userMarker = L.marker([userLat, userLng], {
        icon: L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
        })
    }).addTo(map).bindPopup("Simulated origin").openPopup();

    // Fit map to both points with padding
    var group = new L.featureGroup([userMarker, slotMarker]);
    map.fitBounds(group.getBounds(), { padding: [50, 50] });

    // Draw route using Leaflet Routing Machine from simulated origin -> slot
    L.Routing.control({
        waypoints: [
            L.latLng(userLat, userLng),
            L.latLng(slotLat, slotLng)
        ],
        lineOptions: {
            styles: [{ color: '#2563eb', weight: 5, opacity: 0.8 }]
        },
        routeWhileDragging: false,
        show: false,
        addWaypoints: false,
        draggableWaypoints: false,
        createMarker: function() { return null; } // hide default markers
    }).addTo(map);
});
</script>
{% endblock %}
